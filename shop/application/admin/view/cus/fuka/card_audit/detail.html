{include file="/cus/common/script" /}

<style>
    .card-audit-detail {
        padding: 20px;
    }

    .card-audit-detail .section {
        margin-bottom: 30px;
        background: #fff;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 12px 0 rgba(0, 0, 0, 0.1);
    }

    .card-audit-detail .section-title {
        font-size: 16px;
        font-weight: 600;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 2px solid #409EFF;
    }

    .card-audit-detail .info-row {
        display: flex;
        margin-bottom: 15px;
        line-height: 24px;
    }

    .card-audit-detail .info-label {
        width: 120px;
        color: #606266;
        font-weight: 500;
    }

    .card-audit-detail .info-value {
        flex: 1;
        color: #303133;
    }

    .card-audit-detail .status-badge {
        padding: 4px 12px;
        border-radius: 4px;
        font-size: 14px;
        display: inline-block;
    }

    .card-audit-detail .status-pending {
        color: #E6A23C;
        background: #FDF6EC;
    }

    .card-audit-detail .status-approved {
        color: #67C23A;
        background: #F0F9FF;
    }

    .card-audit-detail .status-rejected {
        color: #F56C6C;
        background: #FEF0F0;
    }

    .card-audit-detail .amount-text {
        color: #F56C6C;
        font-size: 20px;
        font-weight: 600;
    }

    .card-audit-detail .extra-data {
        background: #F5F7FA;
        padding: 15px;
        border-radius: 4px;
        font-family: monospace;
        font-size: 13px;
        line-height: 1.6;
    }

    .card-audit-detail .action-buttons {
        margin-top: 30px;
        text-align: center;
    }
</style>

<div class="card-audit-detail">
    <!-- 用户信息 -->
    <div class="section">
        <div class="section-title">用户信息</div>
        <div class="info-row">
            <div class="info-label">用户ID:</div>
            <div class="info-value">{$row->user_id}</div>
        </div>
        <div class="info-row">
            <div class="info-label">用户名:</div>
            <div class="info-value">{$row->user->username ?? '-'}</div>
        </div>
        <div class="info-row">
            <div class="info-label">真实姓名:</div>
            <div class="info-value">{$row->user->realname ?? '-'}</div>
        </div>
        <div class="info-row">
            <div class="info-label">手机号:</div>
            <div class="info-value">{$row->user->mobile ?? '-'}</div>
        </div>
        <div class="info-row">
            <div class="info-label">身份证号:</div>
            <div class="info-value">{$row->user->idcard ?? '-'}</div>
        </div>
    </div>

    <!-- 金卡信息 -->
    <div class="section">
        <div class="section-title">金卡信息</div>
        <div class="info-row">
            <div class="info-label">金卡ID:</div>
            <div class="info-value">{$row->card_id}</div>
        </div>
        <div class="info-row">
            <div class="info-label">持卡人:</div>
            <div class="info-value">{$row->card->holder_name ?? '-'}</div>
        </div>
        <div class="info-row">
            <div class="info-label">当前流程状态:</div>
            <div class="info-value">步骤{$row->card->flow_status ?? 0}</div>
        </div>
        <div class="info-row">
            <div class="info-label">金卡状态:</div>
            <div class="info-value">{$row->card->status ?? 'normal'}</div>
        </div>
    </div>

    <!-- 流程信息 -->
    <div class="section">
        <div class="section-title">流程信息</div>
        <div class="info-row">
            <div class="info-label">流程步骤:</div>
            <div class="info-value">步骤{$row->flow_step}: {$row->step_name}</div>
        </div>
        <div class="info-row">
            <div class="info-label">流程状态:</div>
            <div class="info-value">
                {if $row->flow_status == 2}
                <span class="status-badge status-pending">待审核</span>
                {elseif $row->flow_status == 3/}
                <span class="status-badge status-approved">已完成</span>
                {elseif $row->flow_status == 4/}
                <span class="status-badge status-rejected">审核拒绝</span>
                {else/}
                <span class="status-badge">{$row->flow_status}</span>
                {/if}
            </div>
        </div>
        <div class="info-row">
            <div class="info-label">支付金额:</div>
            <div class="info-value">
                <span class="amount-text">¥{$row->fee_amount}</span>
            </div>
        </div>
        <div class="info-row">
            <div class="info-label">创建时间:</div>
            <div class="info-value">{$row->createtime|date="Y-m-d H:i:s"}</div>
        </div>
        <div class="info-row">
            <div class="info-label">更新时间:</div>
            <div class="info-value">{$row->updatetime|date="Y-m-d H:i:s"}</div>
        </div>
    </div>

    <!-- 订单信息 -->
    {if isset($row->order_detail)}
    <div class="section">
        <div class="section-title">订单信息</div>
        <div class="info-row">
            <div class="info-label">订单ID:</div>
            <div class="info-value">{$row->order_detail->id}</div>
        </div>
        <div class="info-row">
            <div class="info-label">订单号:</div>
            <div class="info-value">{$row->order_detail->order_no}</div>
        </div>
        <div class="info-row">
            <div class="info-label">支付方式:</div>
            <div class="info-value">{$row->order_detail->pay_type ?: '未支付'}</div>
        </div>
        <div class="info-row">
            <div class="info-label">支付状态:</div>
            <div class="info-value">
                {if $row->order_detail->pay_status == 1}
                <span style="color: #67C23A;">已支付</span>
                {else/}
                <span style="color: #E6A23C;">未支付</span>
                {/if}
            </div>
        </div>
        <div class="info-row">
            <div class="info-label">支付时间:</div>
            <div class="info-value">
                {$row->order_detail->pay_time ? date('Y-m-d H:i:s', $row->order_detail->pay_time) : '-'}
            </div>
        </div>
        <div class="info-row">
            <div class="info-label">第三方单号:</div>
            <div class="info-value">{$row->order_detail->transaction_id ?: '-'}</div>
        </div>
        <div class="info-row">
            <div class="info-label">订单金额:</div>
            <div class="info-value">¥{$row->order_detail->amount}</div>
        </div>
    </div>
    {/if}

    <!-- 额外数据 -->
    {if isset($row->extra_data_json) && !empty($row->extra_data_json)}
    <div class="section">
        <div class="section-title">提交的数据</div>
        <div class="extra-data">
            <pre>{$row->extra_data_json|json_encode:JSON_PRETTY_PRINT|JSON_UNESCAPED_UNICODE}</pre>
        </div>
    </div>
    {/if}

    <!-- 审核信息 -->
    {if $row->auditor_id || $row->audit_time}
    <div class="section">
        <div class="section-title">审核信息</div>
        <div class="info-row">
            <div class="info-label">审核人ID:</div>
            <div class="info-value">{$row->auditor_id ?: '-'}</div>
        </div>
        <div class="info-row">
            <div class="info-label">审核时间:</div>
            <div class="info-value">
                {$row->audit_time ? date('Y-m-d H:i:s', $row->audit_time) : '-'}
            </div>
        </div>
        <div class="info-row">
            <div class="info-label">审核备注:</div>
            <div class="info-value">{$row->audit_remark ?: '-'}</div>
        </div>
    </div>
    {/if}

    <!-- 操作按钮 -->
    {if $row->flow_status == 2}
    <div class="action-buttons">
        {if $auth->check('cus.fuka.card_audit/approve')}
        <button type="button" class="btn btn-success" onclick="onApprove()">
            <i class="fa fa-check"></i> 审核通过
        </button>
        {/if}

        {if $auth->check('cus.fuka.card_audit/reject')}
        <button type="button" class="btn btn-danger" onclick="onReject()">
            <i class="fa fa-times"></i> 审核拒绝
        </button>
        {/if}
    </div>
    {/if}
</div>

<script>
    function onApprove() {
        sa.layer.confirm('确认审核通过该流程？', () => {
            sa.ajax({
                url: '{:url("cus.fuka.card_audit/approve")}',
                type: 'POST',
                data: {
                    ids: '{$row->id}',
                    remark: '审核通过'
                },
                success: (res) => {
                    sa.msg.success(res.msg || '审核通过');
                    setTimeout(() => {
                        parent.location.reload();
                    }, 1000);
                }
            });
        });
    }

    function onReject() {
        sa.layer.prompt({
            title: '请输入拒绝原因',
            formType: 2,
            area: ['400px', '200px']
        }, (reason, layerIndex) => {
            if (!reason || !reason.trim()) {
                sa.msg.error('请输入拒绝原因');
                return false;
            }
            sa.ajax({
                url: '{:url("cus.fuka.card_audit/reject")}',
                type: 'POST',
                data: {
                    ids: '{$row->id}',
                    reason: reason
                },
                success: (res) => {
                    sa.msg.success(res.msg || '已拒绝');
                    setTimeout(() => {
                        parent.location.reload();
                    }, 1000);
                }
            });
        });
    }
</script>

